"use strict";(()=>{var l=(m,g,e)=>new Promise((t,n)=>{var r=s=>{try{a(e.next(s))}catch(o){n(o)}},i=s=>{try{a(e.throw(s))}catch(o){n(o)}},a=s=>s.done?t(s.value):Promise.resolve(s.value).then(r,i);a((e=e.apply(m,g)).next())});var c=class extends HTMLElement{constructor(){super();this.isInitialized=!1;this.testMode=!1;this.attachShadow({mode:"open"})}connectedCallback(){return l(this,null,function*(){this.isInitialized=!0;let e=this.getAttribute("testMode");e&&(console.log("Loading Daze timeslots in test mode - connecting to Daze Preview server"),this.testMode=!0);let t="https://us-central1-daze-web-app.cloudfunctions.net/createSession",n="https://us-central1-daze-preview.cloudfunctions.net/createSession",r=this.getAttribute("backendUrl");if((t==null?void 0:t.length)===0||n.length===0){console.error("BACKEND_URL and PREVIEW_BACKEND_URL environment variables are required");return}let i=e?n:r||t;if(!i){console.error("Error setting backend url");return}i===r&&console.log("Using custom Daze backend URL:",i),this.backendUrl=i,this.sessionId=sessionStorage.getItem("sessionId")||void 0,yield this.createOrUpdateSession(this.getAttribute("orderData")||"{}"),window.addEventListener("message",this.handleMessage.bind(this),!1)})}disconnectedCallback(){this.isInitialized=!1,window.removeEventListener("message",this.handleMessage.bind(this),!1)}createOrUpdateSession(e){return l(this,null,function*(){var t,n,r,i,a,s;if(!this.backendUrl||!this.isInitialized){console.error("backendUrl attribute is missing or component is not connected");return}try{let o=this.sessionId?`${this.backendUrl}?sessionId=${this.sessionId}`:this.backendUrl,h=yield fetch(o,{method:"POST",headers:{"Content-Type":"application/json","x-version":"1.0.0"},body:e});if(!h.ok)throw new Error("Failed to create or update session");this.colorScheme=this.getAttribute("colorScheme")||void 0,this.themeColor=(n=(t=this.getAttribute("themeColor"))==null?void 0:t.replace("#",""))!=null?n:void 0,this.themeColorDark=(i=(r=this.getAttribute("themeColorDark"))==null?void 0:r.replace("#",""))!=null?i:void 0,this.themeColorLight=(s=(a=this.getAttribute("themeColorLight"))==null?void 0:a.replace("#",""))!=null?s:void 0;let u=!!this.colorScheme,f=this.colorScheme==="custom"&&!!(this.themeColor&&this.themeColorDark&&this.themeColorLight);if(!this.isInitialized)return;let d=yield h.json();this.testMode&&(this.sessionId!==d.sessionId?console.log(`New Daze session id: ${d.sessionId}`):console.log(`Updated Daze session with id: ${d.sessionId}`)),this.sessionId=d.sessionId,sessionStorage.setItem("sessionId",this.sessionId),this.iframeSrc=d.url,u&&(this.iframeSrc+=`&colorScheme=${this.colorScheme}`),f&&(this.iframeSrc+=`&themeColor=${this.themeColor}&themeColorDark=${this.themeColorDark}&themeColorLight=${this.themeColorLight}`),this.allowedOrigin=new URL(d.url).origin,this.dispatchEvent(new CustomEvent("onSessionIdChange",{detail:{sessionId:this.sessionId}})),this.renderIframe()}catch(o){if(!this.isInitialized)return;let h=o instanceof Error?o.message:"Could not get Daze session";this.dispatchEvent(new CustomEvent("onError",{detail:h})),console.error("Error creating or updating session:",o)}})}renderIframe(){!this.isInitialized||!this.iframeSrc||(this.shadowRoot.innerHTML=`
            <style>
                :host {
                    display: block;
                    width: 100%;
                    height: 100%;
                    position: relative;
                }
                iframe {
                    width: 100%;
                    height: 100%;
                    border: none;
                }
            </style>
            <iframe src="${this.iframeSrc}" id="timeslotPickerIframe"></iframe>
        `)}handleMessage(e){if(!this.isInitialized||e.origin!==this.allowedOrigin){console.warn("Daze iframe: Invalid event origin:",e.origin);return}switch(e.data.type){case"SUCCESS":this.dispatchEvent(new CustomEvent("onSuccess",{detail:e.data.timeslot}));break;case"ERROR":this.dispatchEvent(new CustomEvent("onError",{detail:e.data.message}));break;default:console.warn("Unknown message type:",e.data.type)}}};customElements.get("timeslot-picker")||customElements.define("timeslot-picker",c);})();
